<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="PT Search">
    <meta name="author" content="harleybai">
    <title>Play List</title>
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="../css/bootstrap-table.min.css" rel="stylesheet">
    <link href="../css/font-awesome.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <style type="text/css">
        html {
            position: relative;
            min-height: 100%;
        }

        body {
            padding-top: 50px;
            margin-bottom: 40px;
        }

        .navbar-fixed-top {
            border: 0;
        }

        .main {
            padding: 20px;
            margin-top: 0;
        }

        @media (min-width: 768px) {
            .main {
                padding-right: 40px;
                padding-left: 40px;
            }
        }

        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #f5f5f5;
        }

        .container {
            width: auto;
            padding: 0 15px;
        }

        td.data-inline {
            word-break: keep-all;
            white-space: nowrap;
        }
    </style>
</head>

<body>
<nav class="navbar navbar-inverse navbar-fixed-top" style="background-color: #f5f5f5">
    <div class="container-fluid">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar"
                    aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">PT Sign In</a>&nbsp;&nbsp;&nbsp;
            <a class="navbar-brand" href="#">Play List</a>&nbsp;&nbsp;&nbsp;
            <a class="navbar-brand" href="/video">Parse Video Link</a>
        </div>
    </div>
</nav>
<div class="container-fluid">
    <div class="row">
        <div class="col-sm-8 col-sm-offset-2 col-md-10 col-md-offset-1 main">
            <div id="toolbar" class="form-inline">
                <button type="button" id="new_site" class="btn btn-primary"><i class="fa fa-plus-square-o"></i> New
                    Video Info
                </button>
            </div>
            <div class="table-responsive">
                <table id="table"></table>
            </div>
        </div>
    </div>
</div>
<footer class="footer">
    <div class="container">
        <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li><a href="https://github.com/harleybai/PTWebSign" target="_blank">Powered By @harleybai</a></li>
            </ul>
        </div>
    </div>
</footer>

<div id="my_modal" class="modal fade" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-ml" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                </button>
                <h4 class="modal-title"></h4>
            </div>
            <div class="modal-body"></div>
            <div class="modal-footer">
                <select id="searchcat" class="form-inline">
                    <option value="0">Video</option>
                    <option value="1">Bgm</option>
                    <option value="2">Douban</option>
                </select>
                <button type="button" id="bgm_auto_fill" class="btn btn-primary">Auto Fill</button>
                <button type="button" id="btn_submit" class="btn btn-primary">Submit</button>
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript
================================================== -->
<!-- Placed at the end of the document so the pages load faster -->
<script src="../js/jquery.min.js"></script>
<script src="../js/bootstrap.min.js"></script>
<script src="../js/bootstrap-table.min.js"></script>
<script>
    //时间格式化
    Date.prototype.format = function (format) {
        let o = {
            "M+": this.getMonth() + 1, //month
            "d+": this.getDate(), //day
            "h+": this.getHours(), //hour
            "m+": this.getMinutes(), //minute
            "s+": this.getSeconds(), //second
            "q+": Math.floor((this.getMonth() + 3) / 3), //quarter
            "S": this.getMilliseconds() //millisecond
        };
        format = (format === "") ? "yyyy-MM-dd hh:mm:ss" : format;
        if (/(y+)/.test(format))
            format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
        for (let k in o)
            if (new RegExp("(" + k + ")").test(format))
                format = format.replace(RegExp.$1, RegExp.$1.length === 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
        return format;
    };

    const dayOfWeek = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    let weekday = dayOfWeek[new Date().getDay()];
    let today = new Date().format("yyyy-MM-dd");

    window.operateEvents = {
        'click .edit': function (e, value, row, index) {
            $('#my_modal div.modal-body').html([
                '<form class="form-horizontal" role="form"><div class="form-group"><label for="f_id" class="col-sm-2 control-label">Id</label><div class="col-sm-10"><input id="f_id" type="text" class="form-control" readonly value="' + row['id'] + '"></div></div>',
                '<div class="form-group"><label for="f_pic" class="col-sm-2 control-label">Pic</label><div class="col-sm-10"><input id="f_pic" type="text" class="form-control" value="' + row['pic'] + '"></div></div>',
                '<div class="form-group"><label for="f_title" class="col-sm-2 control-label">Title</label><div class="col-sm-10"><input id="f_title" type="text" class="form-control" value="' + row['title'] + '"></div></div>',
                '<div class="form-group"><label for="f_progress" class="col-sm-2 control-label">Progress</label><div class="col-sm-10"><input id="f_progress" type="text" class="form-control" value="' + row['progress'] + '"></div></div>',
                '<div class="form-group"><label for="f_week" class="col-sm-2 control-label">Week</label><div class="col-sm-10"><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Monday">星期一</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Tuesday">星期二</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Wednesday">星期三</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Thursday">星期四</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Friday">星期五</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Saturday">星期六</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Sunday">星期日</label></div></div>',
                '<div class="form-group"><label for="f_date" class="col-sm-2 control-label">Date</label><div class="col-sm-10"><input id="f_date" type="date" class="form-control" value="' + row['date'] + '"></div></div>',
                '<div class="form-group"><label for="f_time" class="col-sm-2 control-label">Time</label><div class="col-sm-10"><input id="f_time" type="time" class="form-control" value="' + row['time'] + '"></div></div>',
                '<div class="form-group"><label for="f_douban" class="col-sm-2 control-label">Douban</label><div class="col-sm-10"><input id="f_douban" type="text" class="form-control" value="' + row['douban'] + '"></div></div>',
                '<div class="form-group"><label for="f_bgm" class="col-sm-2 control-label">Bgm</label><div class="col-sm-10"><input id="f_bgm" type="text" class="form-control" value="' + row['bgm'] + '"></div></div>',
                '<div class="form-group"><label for="f_video" class="col-sm-2 control-label">Video</label><div class="col-sm-10"><input id="f_video" type="text" class="form-control" value="' + row['video'] + '"></div></div>',
                '</form>'
            ].join(''));
            let info = {};
            $.getJSON('/play/info?id=' + row['id'], function (res) {
                if (res.code === 0) {
                    info = res.data;
                    if (res.data.type === 1) {
                        $("input#f_date").val("");
                        if (res.data.week !== "") {
                            let week = res.data.week.split(",");
                            $("input:checkbox").each(function () {
                                let w = $(this).val();
                                if (week.indexOf(w) >= 0) {
                                    $(this).attr("checked", 'checked');
                                }
                            });
                        }
                    }
                } else {

                }
                console.log(res);
            });
            $('#my_modal h4').text("Update Video Info ...");
            $('#my_modal').modal();
            //submit
            $('#btn_submit').unbind('click');
            $('#btn_submit').click(function () {
                let data = {};
                data['pic'] = $("input#f_pic").val().trim();
                data['title'] = $("input#f_title").val().trim();
                data['progress'] = $("input#f_progress").val().trim();
                data['week'] = [];
                $.each($("input:checkbox:checked"), function () {
                    data['week'].push($(this).val());
                });
                data['week'] = data['week'].join(",");
                data['date'] = info.type === 0 ? $("input#f_date").val().trim() : "";
                data['time'] = info.type === 0 ? "" : $("input#f_time").val().trim();
                data['douban'] = $("input#f_douban").val().trim();
                data['bgm'] = $("input#f_bgm").val().trim();
                data['video'] = $("input#f_video").val().trim();
                data['id'] = row['id'];

                $.post('/play/update', data, function (res) {
                    console.log(res);
                    if (res.code === 0) {
                        window.location.reload();
                    }
                });
            })
        },
        'click .remove': function (e, value, row, index) {
            $.getJSON('/play/delete?id=' + row['id'], function (res) {
                if (res.code === 0) {
                    $('#table').bootstrapTable('remove', {
                        field: 'id',
                        values: [row['id']]
                    });
                }
                console.log(res);
            });
        }
    };

    $('#table').bootstrapTable({
        classes: "table table-hover table-striped",
        search: true,
        searchAlign: 'left',
        striped: true,
        sortOrder: "asc",
        sortName: "date",
        toolbar: "#toolbar",
        toolbarAlign: "right",
        columns: [{
            field: 'pic',
            title: 'Pic',
            align: 'center',
            valign: 'middle',
            formatter: function (pic) {
                return '<img src="' + pic + '" width="40" />';
            }
        }, {
            field: 'id',
            title: '#',
            align: 'center',
            valign: 'middle',
            visible: false
        }, {
            field: 'title',
            title: 'Title',
            align: 'center',
            valign: 'middle',
            formatter: function (title) {
                return '<b>' + title + '</b>';
            }
        }, {
            field: 'progress',
            title: 'Progress',
            align: 'center',
            valign: 'middle',
            formatter: function (prg) {
                let m = prg.match(/(\d+)\/(\d+)/);
                if (m && m.length === 3) {
                    let progress = parseInt(100 * m[1] / m[2]);
                    let prg_bar_type = ['progress-bar-success', 'progress-bar-info', 'progress-bar-warning', 'progress-bar-danger'];
                    let prg_bar_index = Math.floor(Math.random() * 4);
                    return '<b>' + prg + '</b><br><div class="progress progress-striped" style="height:8px"><div class="progress-bar ' + prg_bar_type[prg_bar_index] + '" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100" style="width:' + progress + '%;"></div></div>';
                }
                return '<b>' + prg + '</b>';
            }
        }, {
            field: 'week',
            title: 'Weekday',
            align: 'center',
            valign: 'middle',
            formatter: function (week) {
                if (week === dayOfWeek[new Date().getDay()]) {
                    return '<span style="color: red; "><b>' + week + '</b></span>';
                }
                return week;
            }
        }, {
            field: 'date',
            title: 'Date',
            align: 'center',
            valign: 'middle',
            sortable: 'true',
            formatter: function (date) {
                if (today === date) {
                    return '<span style="color: red; "><b>' + date + '</b></span>';
                }
                return date;
            }
        }, {
            field: 'time',
            title: 'Time',
            align: 'center',
            valign: 'middle',
            sortable: 'true'
        }, {
            field: 'douban',
            title: 'Douban',
            align: 'center',
            formatter: function (db) {
                if (db === "")
                    return "";
                return '<a href="' + db + '" target="_blank">' + db.match(/subject\/(\d+)/)[1] + '</a>';
            },
            valign: 'middle',
            class: 'data-inline'
        }, {
            field: 'bgm',
            title: 'Bgm',
            align: 'center',
            formatter: function (bgm) {
                if (bgm === "")
                    return "";
                return '<a href="' + bgm + '" target="_blank">' + bgm.match(/subject\/(\d+)/)[1] + '</a>';
            },
            valign: 'middle',
            class: 'data-inline'
        }, {
            field: 'video',
            title: 'Video',
            align: 'left',
            formatter: function (video) {
                if (video === "")
                    return "";
                return '<a href="' + video + '" target="_blank">' + video + '</a>';
            },
            valign: 'middle',
            class: 'data-inline'
        }, {
            field: 'operate',
            title: 'Operate',
            align: 'center',
            valign: 'middle',
            events: window.operateEvents,
            formatter: function () {
                return [
                    '<a class="edit" href="javascript:void(0)" title="Edit"><i class="fa fa-edit fa-fw"></i></a>',
                    '<a class="remove" href="javascript:void(0)" title="Delete"><i class="fa fa-trash"></i></a>'
                ].join('&nbsp;&nbsp;&nbsp;&nbsp;');
            }
        }],
        pagination: true,
        sidePagination: "client",
        pageSize: 50,
        pageList: [10, 25, 50, 100, 200, "ALL"],
        escape: true
    });

    function table_append(data, next_weekday = '') {
        if (data.time !== '' && next_weekday !== '') {
            let dayOfWeek = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
            let indexToday = dayOfWeek.indexOf(weekday);
            let indexNext = dayOfWeek.indexOf(next_weekday);
            data.date = new Date(new Date().getTime() + 24 * 60 * 60 * 1000 * ((7 + indexNext - indexToday) % 7)).format("yyyy-MM-dd");
        }
        $("#table").bootstrapTable('append', {
            'pic': data.pic,
            'id': data.id,
            'title': data.title,
            'progress': data.progress,
            'week': data.week,
            'date': data.date,
            'time': data.time,
            'douban': data.douban,
            'bgm': data.bgm,
            'video': data.video,
            "operate": ""
        });
    }

    $('#new_site').click(function () {
        let now = new Date().format("hh:mm");
        let date = new Date().format("yyyy-MM-dd");
        $('#my_modal div.modal-body').html([
            '<form class="form-horizontal" role="form"><div class="form-group"><label for="f_pic" class="col-sm-2 control-label">Pic</label><div class="col-sm-10"><input id="f_pic" type="text" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_title" class="col-sm-2 control-label">Title</label><div class="col-sm-10"><input id="f_title" type="text" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_type" class="col-sm-2 control-label">Type</label><div class="col-sm-10"><label class="radio-inline"><input name="f_type" type="radio" value="0">电影</label><label class="radio-inline"><input name="f_type" type="radio" value="1" checked>动漫/电视剧</label></div></div>',
            '<div class="form-group"><label for="f_progress" class="col-sm-2 control-label">Progress</label><div class="col-sm-10"><input id="f_progress" type="text" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_week" class="col-sm-2 control-label">Week</label><div class="col-sm-10"><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Monday">星期一</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Tuesday">星期二</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Wednesday">星期三</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Thursday">星期四</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Friday">星期五</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Saturday">星期六</label><label class="checkbox-inline"><input type="checkbox" class="f_week" value="Sunday">星期日</label></div></div>',
            '<div class="form-group"><label for="f_date" class="col-sm-2 control-label">Date</label><div class="col-sm-10"><input id="f_date" type="date" value="" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_time" class="col-sm-2 control-label">Time</label><div class="col-sm-10"><input id="f_time" type="time" value="' + now + '" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_douban" class="col-sm-2 control-label">Douban</label><div class="col-sm-10"><input id="f_douban" type="text" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_bgm" class="col-sm-2 control-label">Bgm</label><div class="col-sm-10"><input id="f_bgm" type="text" class="form-control"></div></div>',
            '<div class="form-group"><label for="f_video" class="col-sm-2 control-label">Video</label><div class="col-sm-10"><input id="f_video" type="text" class="form-control"></div></div>',
            '</form>'
        ].join(''));
        $('#my_modal h4').text("New Video Info ...");
        $('#my_modal').modal();
        $('#btn_submit').unbind('click');
        $('#btn_submit').click(function () {
            let data = {};
            data['pic'] = $("input#f_pic").val().trim();
            data['title'] = $("input#f_title").val().trim();
            data['type'] = parseInt($("input[name='f_type']:checked").val());
            data['progress'] = $("input#f_progress").val().trim();
            data['week'] = [];
            $.each($("input:checkbox:checked"), function () {
                data['week'].push($(this).val());
            });
            data['week'] = data['week'].join(",");
            data['date'] = $("input#f_date").val().trim();
            data['time'] = data['type'] === 0 ? "" : $("input#f_time").val().trim();
            data['douban'] = $("input#f_douban").val().trim();
            data['bgm'] = $("input#f_bgm").val().trim();
            data['video'] = $("input#f_video").val().trim();
            $.post('/play/add', {
                'data': JSON.stringify(data)
            }, function (res) {
                console.log(res);
                $('#my_modal button.close').click();
                table_append(data);
            });
        });
    });

    function get_data() {
        $.getJSON('/play/data', function (data) {
            console.log(data);
            let d = {
                "Sunday": [],
                "Monday": [],
                "Tuesday": [],
                "Wednesday": [],
                "Thursday": [],
                "Friday": [],
                "Saturday": []
            };
            let m = [];
            for (let key in data['data']) {
                if (data['data'][key]['type'] === 0) {
                    m.push(data['data'][key])
                } else if (data['data'][key]['type'] === 1 && data['data'][key]['week'] !== "") {
                    let week = data['data'][key]['week'].split(',');
                    for (let w in week) {
                        let {...temp} = data['data'][key];
                        temp['week'] = week[w];
                        d[week[w]].push(temp)
                    }
                }
            }
            let index = new Date().getDay();
            for (let i = index; i < dayOfWeek.length; i++) {
                for (let key in d[dayOfWeek[i]]) {
                    table_append(d[dayOfWeek[i]][key], dayOfWeek[i]);
                }
            }
            for (let i = 0; i < index; i++) {
                for (let key in d[dayOfWeek[i]]) {
                    table_append(d[dayOfWeek[i]][key], dayOfWeek[i]);
                }
            }
            for (let k in m) {
                table_append(m[k]);
            }
        });
    }

    $(document).ready(get_data());
</script>
</body>

</html>