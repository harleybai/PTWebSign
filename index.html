<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="PT Search">
    <meta name="author" content="harleybai">
    <title>PT Sign In</title>
    <link href="static/css/bootstrap.min.css" rel="stylesheet">
    <link href="static/css/bootstrap-table.min.css" rel="stylesheet">
    <link href="static/css/font-awesome.min.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <style type="text/css">
        html {
            position: relative;
            min-height: 100%;
        }

        body {
            padding-top: 50px;
            margin-bottom: 40px;
        }

        .navbar-fixed-top {
            border: 0;
        }

        .main {
            padding: 20px;
            margin-top: 0;
        }

        @media (min-width: 768px) {
            .main {
                padding-right: 40px;
                padding-left: 40px;
            }
        }

        .footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            background-color: #f5f5f5;
        }

        .container {
            width: auto;
            padding: 0 15px;
        }

        td.data-inline {
            word-break: keep-all;
            white-space: nowrap;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-inverse navbar-fixed-top" style="background-color: #f5f5f5">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="#">PT Sign In</a>&nbsp;&nbsp;&nbsp;
                <a class="navbar-brand" href="/today">Today Play</a>&nbsp;&nbsp;&nbsp;
                <a class="navbar-brand" href="/video">Parse Video Link</a>
            </div>
        </div>
    </nav>
    <div class="container-fluid">
        <div class="row">
            <div class="col-sm-8 col-sm-offset-2 col-md-10 col-md-offset-1 main">
                <div id="toolbar" class="form-inline">
                    <button type="button" id="toggle_status_false" class="btn btn-primary"><i class="fa fa-chevron-down"></i> Show False</button>&nbsp;&nbsp;
                    <button type="button" id="open_all" class="btn btn-primary"><i class="fa fa-refresh"></i> Open All</button>&nbsp;&nbsp;
                    <button type="button" id="new_site" class="btn btn-primary"><i class="fa fa-plus-square-o"></i> New Site</button>
                </div>
                <div class="table-responsive">
                    <table id="table"></table>
                </div>
            </div>
        </div>
    </div>
    <footer class="footer">
        <div class="container">
            <div class="navbar-collapse collapse">
                <ul class="nav navbar-nav navbar-right">
                    <li><a href="https://github.com/harleybai/PTWebSign" target="_blank">Powered By @harleybai</a></li>
                </ul>
            </div>
        </div>
    </footer>

    <div id="my_modal" class="modal fade" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-sm" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span>
                    </button>
                    <h4 class="modal-title"></h4>
                </div>
                <div class="modal-body"></div>
                <div class="modal-footer">
                    <button type="button" id="btn_submit" class="btn btn-primary">Submit</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript
================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>
    <script src="static/js/bootstrap-table.min.js"></script>
    <script>
        window.operateEvents = {
            'click .status': function (e, value, row, index) {
                let status = row['status'] ? false : true;
                $.getJSON('/update/status/' + row['id'], function (res) {
                    $('#table').bootstrapTable('updateCell', {
                        index: index,
                        field: 'status',
                        value: status
                    });
                    console.log(res);
                });
            },
            'click .edit': function (e, value, row, index) {
                $('#my_modal div.modal-body').html([
                    '<form role="form"><div id="p_f_id" class="form-group"><label for="id">Id</label><input id="f_id" type="text" class="form-control" readonly value="' + row['id'] + '"></div>',
                    '<div class="form-group"><label for="name">Name</label><input id="f_name" type="text" class="form-control"></div>',
                    '<div class="form-group"><label for="link">Link</label><input id="f_link" type="text" class="form-control"></div>',
                    '<div class="form-group"><label for="status">Status</label><div class="form-control"><label class="radio-inline"><input type="radio" name="f_status" value="1" id="status_true">true</label><label class="radio-inline"><input type="radio" name="f_status" value="0" id="status_false">false</label></div></div>',
                    '<div class="form-group"><label for="name">Last Date</label><input type="datetime-local" id="f_lastdate" class="form-control">',
                    '<div class="form-group"><label for="desc">Description</label><textarea id="f_desc" class="form-control" rows="3"></textarea></div></form>'
                ].join(''));
                //fill
                $('#my_modal h4').text("Update Info ...");
                $('#my_modal #f_name').val(row["name"]);
                $('#my_modal #f_link').val(row["url"]);
                if (row['status'])
                    $("input#status_true").attr('checked', 'true');
                else
                    $("input#status_false").attr('checked', 'true');
                $('#my_modal #f_lastdate').val(row['lastdate'].trim().replace(' ', 'T'));
                $('#my_modal #f_desc').text(row["desc"]);
                $('#my_modal').modal();
                //submit
                $('#btn_submit').unbind('click');
                $('#btn_submit').click(function () {
                    let t_name = $('#my_modal #f_name').val().trim();
                    let t_url = $('#my_modal #f_link').val().trim();
                    let t_status = $("#my_modal form input:radio:checked").val();
                    let t_lastdate = $('#my_modal #f_lastdate').val().replace('T', ' ');
                    let t_desc = $('#my_modal #f_desc').val().trim();
                    $.getJSON('/update/' + row['id'], {
                        'name': t_name,
                        'url': t_url,
                        'status': t_status,
                        'lastdate': t_lastdate,
                        'desc': t_desc
                    }, function (res) {
                        $('#my_modal button.close').click();
                        row['name'] = t_name;
                        row['url'] = t_url;
                        row['status'] = t_status == '1' ? true : false;
                        row['lastdate'] = t_lastdate;
                        let t_past_hour = parseInt((new Date() - new Date(t_lastdate)) / 3600000);
                        let t_past_day = parseInt(t_past_hour / 24);
                        t_past_hour = t_past_hour - t_past_day * 24;
                        row['pasttime'] = `${t_past_day}天${t_past_hour}小时`;
                        row['desc'] = t_desc;
                        $('#table').bootstrapTable('updateRow', {
                            index: index,
                            row: row
                        });
                        console.log(res);
                    });
                });
            },
            'click .remove': function (e, value, row, index) {
                $.getJSON('/delete/' + row['id'], function (res) {
                    if (res.code == 0) {
                        $('#table').bootstrapTable('remove', {
                            field: 'id',
                            values: row['id']
                        });
                    }
                    console.log(res);
                });

            },
            'click .open': function (e, value, row, index) {
                let now = new Date().format("yyyy-MM-dd hh:mm:ss");
                row['lastdate'] = now;
                row['pasttime'] = '0天0小时';
                window.open(row["url"]);
                $.post('/update', {
                    "data": JSON.stringify([{
                        "id": row['id'],
                        "time": now
                    }])
                }, function (res) {
                    $('#table').bootstrapTable('updateRow', {
                        index: index,
                        row: row
                    });
                    console.log(res);
                });
            }
        }

        var max_days = 2;
        $('#table').bootstrapTable({
            classes: "table table-hover table-striped",
            search: true,
            searchAlign: 'left',
            striped: true,
            sortOrder: "asc",
            sortName: "lastdate",
            toolbar: "#toolbar",
            toolbarAlign: "right",
            columns: [{
                field: 'id',
                title: '#',
                align: 'center',
                valign: 'middle'
            }, {
                field: 'name',
                title: 'Name',
                align: 'left',
                valign: 'middle'
            }, {
                field: 'lastdate',
                title: 'Last Date',
                align: 'center',
                valign: 'middle',
                class: 'data-inline',
                sortable: 'true'
            }, {
                field: 'pasttime',
                title: 'Past Time',
                align: 'center',
                formatter: function (pasttime) {
                    if (parseInt(pasttime) >= max_days) {
                        return '<b style="color: red">' + pasttime + '</b>';
                    }
                    return pasttime;
                },
                valign: 'middle',
                class: 'data-inline',
                sortable: 'true'
            }, {
                field: 'url',
                title: 'Link',
                align: 'left',
                formatter: function (url) {
                    return '<a href="' + url + '" target="_blank">' + url + '</a>';
                },
                valign: 'middle',
                class: 'data-inline'
            }, {
                field: 'status',
                title: 'Status',
                align: 'center',
                formatter: function (s) {
                    if (s) {
                        return '<b style="color: green">True</b>';
                    } else {
                        return '<b style="color: red">False</b>';
                    }
                },
                valign: 'middle',
                class: 'data-inline'
            }, {
                field: 'desc',
                title: 'Description',
                valign: 'middle',
                class: 'data-inline'
            }, {
                field: 'operate',
                title: 'Operate',
                align: 'center',
                valign: 'middle',
                events: window.operateEvents,
                formatter: function () {
                    return [
                        '<a class="status" href="javascript:void(0)" title="Change Status"><i class="fa fa-dot-circle-o"></i></a>',
                        '<a class="edit" href="javascript:void(0)" title="Edit"><i class="fa fa-edit fa-fw"></i></a>',
                        '<a class="open" href="javascript:void(0)" title="Open"><i class="fa fa-share-square"></i></a>'
                    ].join('&nbsp;&nbsp;&nbsp;&nbsp;');
                }
            }],
            pagination: true,
            sidePagination: "client",
            pageSize: 50,
            pageList: [10, 25, 50, 100, 200, "ALL"],
            escape: true
        });

        function table_append(data) {
            $("#table").bootstrapTable('append', {
                'id': data.id,
                'name': data.name,
                'lastdate': data.lastdate,
                'pasttime': data.pasttime,
                'url': data.url,
                'status': data.status,
                'desc': data.desc,
                "operate": ""
            });
        }

        //时间格式化
        Date.prototype.format = function (format) {
            let o = {
                "M+": this.getMonth() + 1, //month
                "d+": this.getDate(), //day
                "h+": this.getHours(), //hour
                "m+": this.getMinutes(), //minute
                "s+": this.getSeconds(), //second
                "q+": Math.floor((this.getMonth() + 3) / 3), //quarter
                "S": this.getMilliseconds() //millisecond
            };
            format = (format == "") ? "yyyy-MM-dd hh:mm:ss" : format;
            if (/(y+)/.test(format))
                format = format.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
            for (let k in o)
                if (new RegExp("(" + k + ")").test(format))
                    format = format.replace(RegExp.$1, RegExp.$1.length === 1 ? o[k] : ("00" + o[k]).substr(("" + o[k]).length));
            return format;
        }

        $('#open_all').click(function () {
            let t_data = $('#table').bootstrapTable('getData');
            let id = [];
            for (let i in t_data) {
                id.push({
                    "id": t_data[i]['id'],
                    "time": new Date().format("yyyy-MM-dd hh:mm:ss")
                });
                window.open(t_data[i]["url"]);
            }
            setTimeout(function () {
                $.post('/update', {
                    "data": JSON.stringify(id)
                }, function () {
                    window.location.reload();
                })
            }, 1000)
        });

        $('#new_site').click(function () {
            $('#my_modal div.modal-body').html([
                '<div class="form-group"><label for="name">Name</label><input id="f_name" type="text" class="form-control"></div>',
                '<div class="form-group"><label for="link">Link</label><input id="f_link" type="text" class="form-control"></div>',
                '<div class="form-group"><label for="desc">Description</label><textarea id="f_desc" class="form-control" rows="3"></textarea></div></form>'
            ].join(''));
            $('#my_modal h4').text("New Site ...");
            $('#my_modal').modal();
            $('#btn_submit').unbind('click');
            $('#btn_submit').click(function () {
                $.getJSON('/add', {
                    'name': $('#my_modal #f_name').val().trim(),
                    'url': $('#my_modal #f_link').val().trim(),
                    'lastdate': new Date().format("yyyy-MM-dd hh:mm:ss"),
                    'desc': $('#my_modal #f_desc').val().trim()
                }, function (res) {
                    console.log(res);
                    $('#my_modal button.close').click();
                    window.location.reload();
                });
            })
        });

        var status_false_site = [];

        function get_data() {
            $.getJSON('/data', function (data) {
                max_days = parseInt(data['maxdays']);
                for (let index in data['data']) {
                    if (!data['data'][index].status) {
                        status_false_site.push(data['data'][index]);
                        continue;
                    }
                    table_append(data['data'][index]);
                }
            });
        }

        $('button#toggle_status_false').click(function () {
            let text = $('button#toggle_status_false').text();
            if (text.match(/Show False/)) {
                for (let index = 0; index < status_false_site.length; index++) {
                    table_append(status_false_site[index]);
                }
                $('button#toggle_status_false').html('<i class="fa fa-chevron-up"></i> Hide False');
            } else {
                let ids = [];
                for (let index = 0; index < status_false_site.length; index++) {
                    ids.push(status_false_site[index].id);
                }
                $("#table").bootstrapTable('remove', {
                    field: 'id',
                    values: ids
                });
                $('button#toggle_status_false').html('<i class="fa fa-chevron-down"></i> Show False');
            }
        });

        $(document).ready(get_data());
    </script>
</body>

</html>